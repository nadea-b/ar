<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>The Secret Garden's Lost Butterflies</title>
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- AR.js for A-Frame (marker-based AR) -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  
  <style>
    .arjs-loader {
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .arjs-loader div {
      text-align: center;
      font-size: 1.25em;
      color: white;
      font-family: 'Arial', sans-serif;
      margin: 10px;
    }

    .hud-overlay {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 15px 30px;
      border-radius: 20px;
      font-family: 'Arial', sans-serif;
      text-align: center;
      backdrop-filter: blur(10px);
      display: none;
    }

    .hud-overlay.show {
      display: block;
      animation: slideDown 0.5s ease;
    }

    @keyframes slideDown {
      from { top: -100px; opacity: 0; }
      to { top: 20px; opacity: 1; }
    }

    .locked-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,0,0,0.8);
      color: white;
      padding: 30px;
      border-radius: 15px;
      font-size: 1.2em;
      text-align: center;
      z-index: 1001;
      display: none;
      font-family: 'Arial', sans-serif;
    }

    .instructions {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #FFD700;
      padding: 15px 25px;
      border-radius: 15px;
      font-family: 'Arial', sans-serif;
      text-align: center;
      z-index: 1000;
      max-width: 90%;
    }
  </style>
</head>

<body style="margin: 0px; overflow: hidden;">
  <!-- Loader -->
  <div class="arjs-loader">
    <div>ðŸ¦‹ The Secret Garden's Lost Butterflies ðŸ¦‹</div>
    <div>Loading magical experience...</div>
  </div>

  <!-- HUD Overlay for Progress -->
  <div class="hud-overlay" id="hudOverlay">
    <div id="hudText">Scan a flower to begin...</div>
    <div style="margin-top: 10px; font-size: 0.9em;" id="hudProgress">Progress: 0/3</div>
  </div>

  <!-- Instructions -->
  <div class="instructions">
    ðŸ“± Point camera at flower markers<br>
    ðŸ‘† Tap butterflies to interact
  </div>

  <!-- Locked Message -->
  <div class="locked-message" id="lockedMessage">
    This flower is locked!<br>
    <span style="font-size: 0.8em; margin-top: 10px; display: block;">Find the previous flowers first</span>
  </div>

  <!-- A-Frame Scene -->
  <a-scene
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; precision: high;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
  >
    <a-assets timeout="10000">
      <a-asset-item id="butterfly1Model" src="./butterfly1.glb"></a-asset-item>
      <a-asset-item id="butterfly2Model" src="./butterfly2.glb"></a-asset-item>
      <a-asset-item id="butterfly3Model" src="./butterfly3.glb"></a-asset-item>
    </a-assets>
    
    <a-nft 
    type="nft" 
    url="./markers/flower1"
    id="flower1-marker"
    >
    
    <a-entity 
      id="butterfly1"
      gltf-model="#butterfly1Model"
      position="100 2 -20"
      scale="400 400 400"
      rotation="0 180 0">
        <a-box id="box1" class="clickable" 
        width="0.15" height="0.15" depth="0.15" 
        position="0 -0.1 0" 
        opacity="0">
        </a-box>
    </a-entity>

    <a-text 
      id="riddle1"
      value="A yellow glow that warns the wise,\nTouch with care, and claim the prize."
      color="pink"
      visible="false"
      position="65 1 -80"
      scale="30 30 30"
      rotation="-90 0 0"
      wrap-count="30"
    ></a-text>

    <a-text
      id="progress1"
      value="1/3"
      visible="false"
      position="95 2.5 13"
      scale="30 30 30"
      color="white"
      rotation="-90 0 0"
    ></a-text>
    </a-nft>

    <a-nft
      type="nft"
      url="./markers/flower2"
      id="flower2-marker"
    >
      <a-entity 
      id="butterfly2"
      gltf-model="#butterfly2Model"
      position="80 2 -50"
      scale="5 5 5"
      rotation="10 135 0"
      visible="false">
        <a-box id="box2" class="clickable" 
        width="9" height="9" depth="9" 
        position="0 0.2 0" 
        opacity="0">
        </a-box>
      </a-entity>
    
      <a-text 
        id="riddle2"
        value="Follow the trail of purple light, \nA fragrant treasure waits in sight."
        color="yellow"
        visible="false"
        position="105 1 -80"
        scale="30 30 30"
        rotation="-90 0 0"
        wrap-count="30"
      ></a-text>
    
    
      <a-text
        id="progress2"
        value="2/3"
        visible="false"
        position="80 2.5 10"
        scale="30 30 30"
        color="white"
        rotation="-90 0 0"
      ></a-text>
    </a-nft>

    <a-nft
      type="nft"
      url="./markers/flower3"
      id="flower3-marker"
    >
    <a-entity 
    id="butterfly3"
    gltf-model="#butterfly3Model"
    position="175 2 -90"
    scale="9 9 9"
    rotation="10 135 0"
    visible="false">
      <a-box id="box3" class="clickable" 
      width="5" height="5" depth="5" 
      position="0 0.2 0" 
      opacity="0">
      </a-box>
    </a-entity>
  
    <a-text 
      id="riddle3"
      value="Congratulations,\nYour wish awaits the touch of light."
      color="EAC0FC"
      visible="false"
      position="95 1 -20"
      scale="30 30 30"
      rotation="-90 0 0"
      wrap-count="30"
    ></a-text>
  
  
    <a-text
      id="progress3"
      value="3/3"
      visible="false"
      position="180 2.5 -35"
      scale="30 30 30"
      color="white"
      rotation="-90 0 0"
    ></a-text>
    </a-nft>
    
    <a-nft
  type="nft"
  url="./markers/flower4"
  id="flower4-marker"
>
  <a-entity 
    id="butterfly4"
    gltf-model="#butterfly3Model"
    position="175 2 -90"
    scale="9 9 9"
    rotation="10 135 0"
    visible="false">
      <a-box id="box4" class="clickable" 
      width="5" height="5" depth="5" 
      position="0 0.2 0" 
      opacity="0">
      </a-box>
  </a-entity>

  <a-text 
    id="riddle4"
    value="Congratulations,\nYour wish awaits the touch of light."
    color="EAC0FC"
    visible="false"
    position="95 1 -20"
    scale="30 30 30"
    rotation="-90 0 0"
    wrap-count="30"
  ></a-text>

  <a-text
    id="progress4"
    value="4/4"
    visible="false"
    position="180 2.5 -35"
    scale="30 30 30"
    color="white"
    rotation="-90 0 0"
  ></a-text>
</a-nft>


    <a-entity camera="fov: 70; near: 0.1; far: 1000">
      <a-entity cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>
    </a-entity>
    
  </a-scene>

  <script>
    // Suppress WebXR error
    console.warn = function(msg) { 
      if (msg.includes && msg.includes('hasLoaded')) return;
      console.log(msg); 
    };

    // Game state
    let gameState = {
      flower1Found: false,
      flower2Found: false,
      flower3Found: false,
      flower4Found: false,
      butterfly1Clicked: false,
      butterfly2Clicked: false,
      butterfly3Clicked: false,
      butterfly4Clicked: false,
      startTime: null
    };

    // Wait for scene to load
    document.addEventListener('DOMContentLoaded', function() {
      // Hide loader after delay
      setTimeout(() => {
        const loader = document.querySelector('.arjs-loader');
        if (loader) loader.style.display = 'none';

        const hud = document.getElementById('hudOverlay');
        if (hud) hud.classList.add('show');
      }, 3000);

      // Wait for AR.js to fully initialize
      const scene = document.querySelector('a-scene');
      if (scene.hasLoaded) {
        setupMarkerListeners();
        setupClickListeners();
      } else {
        scene.addEventListener('loaded', () => {
          setupMarkerListeners();
          setupClickListeners();
        });
      }
    });

    function setupMarkerListeners() {
      // Flower 1
      const marker1 = document.getElementById('flower1-marker');
      if (marker1) {
        marker1.addEventListener('markerFound', () => {
          console.log('âœ“ Flower 1 marker detected!');
          if (!gameState.startTime) gameState.startTime = Date.now();
          gameState.flower1Found = true;
          updateHUD('Pink flowers found! Tap the butterfly!', '1/3');
        });
        marker1.addEventListener('markerLost', () => {
          console.log('âœ— Flower 1 marker lost');
        });
      }

      // Flower 2
      const marker2 = document.getElementById('flower2-marker');
      if (marker2) {
        marker2.addEventListener('markerFound', () => {
          console.log('âœ“ Flower 2 marker detected!');
          if (!gameState.flower1Found) {
            showLockedMessage();
            return;
          }
          gameState.flower2Found = true;
          document.getElementById('butterfly2').setAttribute('visible', true);
          updateHUD('Yellow flowers found! Tap the butterfly!', '2/3');
        });
        marker2.addEventListener('markerLost', () => {
          console.log('âœ— Flower 2 marker lost');
        });
      }

      // Flower 3
      const marker3 = document.getElementById('flower3-marker');
      if (marker3) {
        marker3.addEventListener('markerFound', () => {
          console.log('âœ“ Flower 3 marker detected!');
          if (!gameState.flower1Found || !gameState.flower2Found) {
            showLockedMessage();
            return;
          }
          gameState.flower3Found = true;
          document.getElementById('butterfly3').setAttribute('visible', true);
          updateHUD('Magical batterfly found! The wish is yours!', '3/3 COMPLETE!');
        });
        marker3.addEventListener('markerLost', () => {
          console.log('âœ— Flower 3 marker lost');
        });
      }

      // Flower 4
      const marker4 = document.getElementById('flower4-marker');
      if (marker4) {
        marker4.addEventListener('markerFound', () => {
          console.log('âœ“ Flower 4 marker detected!');

          if (!gameState.flower1Found || !gameState.flower2Found) {
            showLockedMessage();
            return;
          }

          gameState.flower4Found = true;
          document.getElementById('butterfly4').setAttribute('visible', true);
          updateHUD('Final magical butterfly found!', '4/4 COMPLETE!');
        });

        marker4.addEventListener('markerLost', () => {
          console.log('âœ— Flower 4 marker lost');
        });
      }
    }

    function setupClickListeners() {
      // Use mousedown for better mobile support
      const butterfly1 = document.getElementById('butterfly1');
      if (butterfly1) {
        butterfly1.addEventListener('mousedown', handleButterfly1Click);
        butterfly1.addEventListener('touchstart', handleButterfly1Click);
      }

      const butterfly2 = document.getElementById('butterfly2');
      if (butterfly2) {
        butterfly2.addEventListener('mousedown', handleButterfly2Click);
        butterfly2.addEventListener('touchstart', handleButterfly2Click);
      }

      const butterfly3 = document.getElementById('butterfly3');
      if (butterfly3) {
        butterfly3.addEventListener('mousedown', handleButterfly3Click);
        butterfly3.addEventListener('touchstart', handleButterfly3Click);
      }

      const butterfly4 = document.getElementById('butterfly4');
      if (butterfly4) {
        butterfly4.addEventListener('mousedown', handleButterfly4Click);
        butterfly4.addEventListener('touchstart', handleButterfly4Click);
      }

      const box1 = document.getElementById('box1');
      if (box1) {
        box1.addEventListener('mousedown', () => {
          box1.setAttribute('animation', 'property: rotation; to: 5 0 0; dur: 100; dir: alternate; loop: 3');
        });
      }

      const box2 = document.getElementById('box2');
      if (box2) {
        box2.addEventListener('mousedown', () => {
          box2.setAttribute('animation', 'property: rotation; to: 0 10 0; dur: 200; dir: alternate; loop: 2');
        });
      }

      const box3 = document.getElementById('box3');
      if (box3) {
        box3.addEventListener('mousedown', () => {
          box3.setAttribute('animation', 'property: rotation; to: 0 10 0; dur: 200; dir: alternate; loop: 2');
        });
      }

      const box4 = document.getElementById('box4');
      if (box4) {
        box4.addEventListener('mousedown', () => {
          box4.setAttribute('animation', 'property: rotation; to: 0 10 0; dur: 200; dir: alternate; loop: 2');
        });
      }

      const unitedButterflies = document.getElementById('united-butterflies');
      if (unitedButterflies) {
        unitedButterflies.addEventListener('mousedown', () => {
          if (gameState.flower3Found) {
            document.getElementById('sparkles').setAttribute('visible', 'true');
          }
        });
      }
    }

    function handleButterfly1Click(e) {
      console.log('1 butterfly clicked');
      e.preventDefault();
      e.stopPropagation();
      if (gameState.flower1Found && !gameState.butterfly1Clicked) {
        gameState.butterfly1Clicked = true;
        document.getElementById('riddle1').setAttribute('visible', 'true');
        document.getElementById('progress1').setAttribute('visible', 'true');
        updateHUD('Riddle revealed! Find the next flowers!', '1/3');
        console.log('âœ“ Butterfly 1 clicked - riddle revealed');
      }
    }

    function handleButterfly2Click(e) {
      console.log('2 butterfly clicked');
      e.preventDefault();
      e.stopPropagation();
      if (gameState.flower2Found && !gameState.butterfly2Clicked) {
        gameState.butterfly2Clicked = true;
        document.getElementById('riddle2').setAttribute('visible', 'true');
        document.getElementById('progress2').setAttribute('visible', 'true');
        updateHUD('Find the final batterfly to make a wish!', '2/3');
        console.log('âœ“ Butterfly 2 clicked');
      }
    }

    function handleButterfly3Click(e) {
      console.log('3 butterfly clicked');
      e.preventDefault();
      e.stopPropagation();
      
      if (gameState.flower3Found && !gameState.butterfly3Clicked) {
          gameState.butterfly3Clicked = true;
          document.getElementById('riddle3').setAttribute('visible', 'true');
          document.getElementById('progress3').setAttribute('visible', 'true');
          updateHUD('You can make a wish!', '3/3');
          console.log('âœ“ Butterfly 3 clicked');
      }
    }

    function handleButterfly4Click(e) {
      console.log('4 butterfly clicked');
      e.preventDefault();
      e.stopPropagation();

      if (gameState.flower4Found && !gameState.butterfly4Clicked) {
        gameState.butterfly4Clicked = true;
        document.getElementById('riddle4').setAttribute('visible', 'true');
        document.getElementById('progress4').setAttribute('visible', 'true');
        updateHUD('Final riddle revealed!', '4/4');
        console.log('âœ“ Butterfly 4 clicked');
      }
    }

    function updateHUD(text, progress) {
      document.getElementById('hudText').textContent = text;
      document.getElementById('hudProgress').textContent = 'Progress: ' + progress;
    }

    function showLockedMessage() {
      const msg = document.getElementById('lockedMessage');
      msg.style.display = 'block';
      setTimeout(() => {
        msg.style.display = 'none';
      }, 2000);
    }
  </script>
</body>
</html>